{% extends "layout.html" %}
{% block title %}Consult Doctor{% endblock %}

{% block content %}
<section>
    <h2 style="text-align: center; color: var(--color-primary); margin-bottom: 10px;">Consult a Doctor</h2>
    <p style="text-align: center; margin-bottom: 30px; color: #666; max-width: 900px; margin-left: auto; margin-right: auto;">Search and book consultations with our network of experienced doctors.</p>

    <!-- Search Bar -->
    <div style="max-width: 900px; margin: 0 auto 40px; padding: 0 20px;">
        <input type="text" id="searchInput" placeholder="Search doctor by name or specialization..." onkeyup="filterDoctors()" style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box;">
    </div>

    <!-- Doctors Grid -->
    <!-- Doctors Grid -->
    <div id="doctorsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; max-width: 1200px; margin: 0 auto 50px; padding: 0 20px;">
        
        {% set doctors = [
            {"id": 1, "name": "Dr. Rajesh Sharma", "specialty": "General Practice", "experience": "10+ years", "address": "Apollo Health Center, Delhi", "phone": "+91-9876543210"},
            {"id": 2, "name": "Dr. Priya Desai", "specialty": "Internal Medicine", "experience": "8 years", "address": "Care Clinic, Mumbai", "phone": "+91-9765432109"},
            {"id": 3, "name": "Dr. Arun Kumar", "specialty": "Endocrinology", "experience": "12 years", "address": "Thyroid Center, Bangalore", "phone": "+91-9654321098"},
            {"id": 4, "name": "Dr. Neha Gupta", "specialty": "Hepatology", "experience": "9 years", "address": "Liver Clinic, Delhi", "phone": "+91-9543210987"},
            {"id": 5, "name": "Dr. Vikram Singh", "specialty": "Cardiology", "experience": "11 years", "address": "Heart Care Center, Pune", "phone": "+91-9432109876"},
            {"id": 6, "name": "Dr. Anjali Patel", "specialty": "Pulmonology", "experience": "11 years", "address": "Chest Hospital, Ahmedabad", "phone": "+91-9321098765"},
            {"id": 7, "name": "Dr. Sanjay Verma", "specialty": "Infectious Disease", "experience": "8 years", "address": "Infection Hospital, Delhi", "phone": "+91-9210987654"},
            {"id": 8, "name": "Dr. Meera Singh", "specialty": "General Practitioner", "experience": "15 years", "address": "General Clinic, Noida", "phone": "+91-9109876543"},
            {"id": 9, "name": "Dr. Harish Reddy", "specialty": "Preventive Medicine", "experience": "7 years", "address": "Health Center, Hyderabad", "phone": "+91-8987654321"},
            {"id": 10, "name": "Dr. Pooja Nair", "specialty": "Clinical Pathologist", "experience": "10 years", "address": "Diagnostic Lab, Kochi", "phone": "+91-8876543210"},
            {"id": 11, "name": "Dr. Amit Gupta", "specialty": "Nephrology", "experience": "9 years", "address": "Kidney Care Center, Delhi", "phone": "+91-8765432109"},
            {"id": 12, "name": "Dr. Sunita Rao", "specialty": "Thyroid Specialist", "experience": "10 years", "address": "Endocrine Clinic, Bangalore", "phone": "+91-8654321098"},
            {"id": 13, "name": "Dr. Rohit Kumar", "specialty": "Cardiologist", "experience": "12 years", "address": "Cardiac Institute, Mumbai", "phone": "+91-8543210987"},
            {"id": 14, "name": "Dr. Kavya Pillai", "specialty": "Hepatologist", "experience": "8 years", "address": "Liver Wellness, Kochi", "phone": "+91-8432109876"},
            {"id": 15, "name": "Dr. Nikhil Sharma", "specialty": "Pulmonary Medicine", "experience": "9 years", "address": "Respiratory Care, Delhi", "phone": "+91-8321098765"}
        ] %}

        {% for doctor in doctors %}
        <div class="doctor-card" id="doctor-{{ doctor.id }}" data-name="{{ doctor.name.lower() }}" data-specialty="{{ doctor.specialty.lower() }}" style="background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 25px; text-align: center; transition: box-shadow 0.3s; display: block;">
            
            <!-- Doctor Name (Centered) -->
            <h3 style="margin: 0 0 15px 0; color: var(--color-primary); font-size: 1.15rem;">{{ doctor.name }}</h3>
            
            <!-- Details Box -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; text-align: left;">
                <p style="margin: 8px 0; color: #333; font-size: 0.95rem;"><strong>Specialization:</strong> {{ doctor.specialty }}</p>
                <p style="margin: 8px 0; color: #333; font-size: 0.95rem;"><strong>Experience:</strong> {{ doctor.experience }}</p>
                <p style="margin: 8px 0; color: #666; font-size: 0.9rem;"><strong>Address:</strong> {{ doctor.address }}</p>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <a href="tel:{{ doctor.phone }}" style="padding: 10px; background-color: var(--color-secondary); color: white; border: none; border-radius: 4px; text-decoration: none; font-weight: 600; cursor: pointer; font-size: 0.9rem; text-align: center;">Call</a>
                <button onclick="openBookingModal('{{ doctor.name }}', {{ doctor.id }})" style="padding: 10px; background-color: var(--color-primary); color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.9rem;">Book</button>
            </div>
        </div>
        {% endfor %}

    </div>

    <div id="noResults" style="display: none; text-align: center; padding: 40px; color: #999;">
        <p style="font-size: 1.1rem;">No doctors found matching your search.</p>
    </div>

    <!-- Appointment Modal -->
    <div id="bookingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 40px; border-radius: 8px; max-width: 450px; width: 90%; box-shadow: 0 8px 30px rgba(0,0,0,0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 style="color: var(--color-primary); margin: 0;">Consultation Request</h3>
                <button onclick="closeBookingModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">✕</button>
            </div>

            <form id="bookingForm" style="display: flex; flex-direction: column; gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 0.9rem;">Doctor*</label>
                    <input type="text" id="modalDoctorName" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa; color: #666; box-sizing: border-box;">
                </div>

                <div>
                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 0.9rem;">Your Name*</label>
                    <input type="text" id="modalPatientName" placeholder="Full name" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                </div>

                <div>
                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 0.9rem;">Mobile Number*</label>
                    <input type="tel" id="modalMobileNumber" placeholder="10-digit number" required pattern="[0-9]{10}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                </div>

                <div>
                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 0.9rem;">Expected Visit Window*</label>
                    <select id="modalVisitWindow" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; background-color: white;">
                        <option value="">-- Select timeframe --</option>
                        <option value="1-2 days">Within 1–2 days</option>
                        <option value="3-4 days">Within 3–4 days</option>
                        <option value="within a week">Within a week</option>
                    </select>
                </div>

                <div>
                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 0.9rem;">Problem Summary*</label>
                    <textarea id="modalProblemSummary" placeholder="Describe your concern..." required rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: inherit; resize: vertical;"></textarea>
                    <p style="margin: 6px 0 0 0; font-size: 0.8rem; color: #999;">Max 500 characters</p>
                </div>

                <button type="submit" style="padding: 10px; background-color: var(--color-primary); color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.95rem;">Submit Request</button>
            </form>

            <div id="modalMessage" style="text-align: center; margin-top: 15px; font-weight: 500; display: none; font-size: 0.9rem;"></div>
        </div>
    </div>

    <!-- Info Note -->
    <div style="background-color: #e7f3ff; border-left: 4px solid var(--color-primary); padding: 15px; margin-top: 40px; border-radius: 4px; max-width: 900px; margin-left: auto; margin-right: auto;">
        <p style="margin: 0; color: #0056b3; font-size: 0.95rem;"><strong>Note:</strong> This is an offline consultation request. You will be contacted based on doctor availability. No time slots are guaranteed.</p>
    </div>
</section>

<script>
    function filterDoctors() {
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        const doctorCards = document.querySelectorAll('.doctor-card');
        const noResults = document.getElementById('noResults');
        let visibleCount = 0;

        doctorCards.forEach(card => {
            const name = card.dataset.name;
            const specialty = card.dataset.specialty;

            if (name.includes(searchInput) || specialty.includes(searchInput) || searchInput === '') {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    }

    function openBookingModal(doctorName, doctorId) {
        document.getElementById('modalDoctorName').value = doctorName;
        document.getElementById('bookingModal').style.display = 'flex';
        document.getElementById('modalMessage').style.display = 'none';
        document.getElementById('bookingForm').reset();
    }

    function closeBookingModal() {
        document.getElementById('bookingModal').style.display = 'none';
        document.getElementById('bookingForm').reset();
        document.getElementById('modalMessage').style.display = 'none';
    }

    document.getElementById('bookingForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const doctorName = document.getElementById('modalDoctorName').value;
        const patientName = document.getElementById('modalPatientName').value.trim();
        const mobileNumber = document.getElementById('modalMobileNumber').value.trim();
        const visitWindow = document.getElementById('modalVisitWindow').value;
        const problemSummary = document.getElementById('modalProblemSummary').value.trim();
        
        // Validation
        if (!patientName) {
            showModalMessage('Please enter your name.', 'error');
            return;
        }
        if (!mobileNumber || mobileNumber.length !== 10 || isNaN(mobileNumber)) {
            showModalMessage('Please enter a valid 10-digit mobile number.', 'error');
            return;
        }
        if (!visitWindow) {
            showModalMessage('Please select an expected visit window.', 'error');
            return;
        }
        if (!problemSummary) {
            showModalMessage('Please describe your health concern.', 'error');
            return;
        }
        if (problemSummary.length > 500) {
            showModalMessage('Problem summary cannot exceed 500 characters.', 'error');
            return;
        }
        
        const formData = {
            doctor_name: doctorName,
            patient_name: patientName,
            mobile_number: mobileNumber,
            expected_visit_window: visitWindow,
            problem_summary: problemSummary
        };

        try {
            const response = await fetch('{{ url_for("submit_consultation_intent") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (data.status === 'success') {
                showModalMessage('✓ Request submitted successfully. We will contact you soon.', 'success');
                setTimeout(() => {
                    closeBookingModal();
                }, 2000);
            } else {
                showModalMessage(data.message || 'Failed to submit. Please try again.', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showModalMessage('An error occurred. Please try again.', 'error');
        }
    });

    function showModalMessage(message, type) {
        const messageDiv = document.getElementById('modalMessage');
        messageDiv.textContent = message;
        messageDiv.style.color = type === 'success' ? 'var(--color-success)' : 'var(--color-danger)';
        messageDiv.style.display = 'block';
    }

    // Close modal when clicking outside
    document.getElementById('bookingModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeBookingModal();
        }
    });
</script>
{% endblock %}