{% extends "layout.html" %}

{% block title %}Disease Detection{% endblock %}

{% block content %}
<section class="detection-section">
    <h1 class="page-title">Disease Detection</h1>
    <p class="tagline">Select a disease to begin the risk analysis. Your data is processed ethically and securely.</p>

    <div class="disease-cards-grid">
        {% for disease in diseases %}
            {% set d_name = disease | replace('_', ' ') | title %}
            <div class="card disease-card" data-disease-key="{{ disease }}" onclick="showForm('{{ disease }}', '{{ d_name }}')">
                <i class="fas fa-heartbeat"></i> <h3>{{ d_name }}</h3>
                <p>Predict risk for {{ d_name }}.</p>
            </div>
        {% endfor %}
    </div>

    <hr class="section-divider">

    <div id="form-container" class="card form-card hidden">
        <h2 id="form-title"></h2>
        <form id="prediction-form">
            <div id="input-fields-area" class="input-fields-grid"></div>
            <button type="submit" class="btn primary predict-button">
                <i class="fas fa-brain"></i> Predict Risk
            </button>
            <div id="loading-spinner" class="spinner hidden"></div>
        </form>
    </div>

    <div id="results-container" class="results-card hidden"></div>
</section>
{% endblock %}

{% block scripts %}
<script>
    const DISEASE_PARAMS = JSON.parse('{{ DISEASE_PARAMETERS | tojson }}');
    const CATEGORICAL_FIELDS = ['Blood_Pressure', 'Sex', 'Thyroxine', 'cp', 'sex', 'exang', 'Headache', 'Vomiting', 'JointPain', 'Gender', 'CoughSeverity']; 

    // Mapping of parameter names to full descriptive names
    const PARAM_LABELS = {
        'Pregnancies': 'Number of Pregnancies',
        'Glucose': 'Glucose Level (mg/dL)',
        'BloodPressure': 'Blood Pressure (mmHg)',
        'BMI': 'Body Mass Index (BMI)',
        'Age': 'Age (years)',
        'Gender': 'Gender',
        'sg': 'Specific Gravity',
        'al': 'Albumin (mg/dL)',
        'rbc': 'Red Blood Cells (RBC)',
        'pc': 'Pus Cells',
        'hemo': 'Hemoglobin (g/dL)',
        'wc': 'White Blood Cells (WBC)',
        'rc': 'Red Blood Cell Count',
        'bp': 'Blood Pressure (mmHg)',
        'age': 'Age (years)',
        'sex': 'Sex',
        'Sex': 'Sex',
        'Total_Bilirubin': 'Total Bilirubin (mg/dL)',
        'Direct_Bilirubin': 'Direct Bilirubin (mg/dL)',
        'Alkaline_Phosphotase': 'Alkaline Phosphatase (IU/L)',
        'Alamine_Aminotransferase': 'Alamine Aminotransferase (IU/L)',
        'Aspartate_Aminotransferase': 'Aspartate Aminotransferase (IU/L)',
        'Blood_Pressure': 'Blood Pressure Status',
        'TSH': 'TSH Level (µIU/mL)',
        'T3': 'T3 Level (ng/dL)',
        'T4': 'T4 Level (µg/dL)',
        'Thyroxine': 'Thyroxine Status',
        'Temperature': 'Temperature (°C)',
        'Headache': 'Headache Severity',
        'Vomiting': 'Vomiting Status',
        'JointPain': 'Joint Pain Status',
        'Joint_Pain': 'Joint Pain Status',
        'RBC': 'Red Blood Cell Count (millions/µL)'
    };

    function getParameterLabel(param) {
        return PARAM_LABELS[param] || param.replace(/_/g, ' ');
    }

    function getDropdownOptions(param, diseaseKey) {
        if (param === 'Blood_Pressure') {
            return '<option value="Normal">Normal</option><option value="Abnormal">Abnormal</option>';
        } else if (param === 'Gender') {
            return '<option value="">Select Gender</option><option value="male">male</option><option value="female">female</option>';
        } else if (param === 'Sex' || param === 'sex') {
            return '<option value="">Select Sex</option><option value="Male">Male</option><option value="Female">Female</option>';
        } else if (param === 'Thyroxine') {
            return '<option value="">Select Thyroxine Status</option><option value="Normal">Normal</option><option value="High">High</option><option value="Low">Low</option>';
        } else if (param === 'CoughSeverity') {
            return '<option value="">Select Cough Severity</option><option value="0">none</option><option value="1">present</option>';
        } else if (param === 'Headache') {
            return '<option value="">Select Headache Severity</option><option value="0">None</option><option value="1">Present</option><option value="2">Severe</option>';
        } else if (param === 'Vomiting') {
            return '<option value="">Select Vomiting Status</option><option value="0">None</option><option value="1">Present</option><option value="2">Severe</option>';
        } else if (param === 'JointPain') {
            return '<option value="">Select Joint Pain Status</option><option value="0">None</option><option value="1">Present</option><option value="2">Severe</option>';
        }
        return '<option value="Normal">Normal</option><option value="Abnormal">Abnormal</option>';
    }

    function getResultClass(result) {
        switch (result) {
            case 'Healthy': return 'result-healthy';
            case 'Borderline': return 'result-borderline';
            case 'Risky': return 'result-risky';
            default: return 'result-unknown';
        }
    }

    window.onload = function() {
        const formContainer = document.getElementById('form-container');
        const formTitle = document.getElementById('form-title');
        const inputArea = document.getElementById('input-fields-area');
        const predictionForm = document.getElementById('prediction-form');
        const resultsContainer = document.getElementById('results-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        let currentDiseaseKey = ''; // Track current disease
        
        // Function to toggle Pregnancies field based on Gender
        function togglePregnanciesField() {
            if (currentDiseaseKey === 'diabetes') {
                const genderSelect = document.querySelector('[name="_ui_gender"]');
                const pregnanciesGroup = document.getElementById('Pregnancies-group');
                if (genderSelect && pregnanciesGroup) {
                    const isFemale = genderSelect.value === 'Female';
                    pregnanciesGroup.style.display = isFemale ? 'block' : 'none';
                    const pregnanciesInput = document.getElementById('Pregnancies');
                    if (pregnanciesInput) {
                        pregnanciesInput.required = isFemale;
                    }
                }
            }
        }
        
        window.showForm = function(diseaseKey, diseaseName) {
            currentDiseaseKey = diseaseKey;
            formTitle.textContent = `Input Parameters for ${diseaseName}`;
            predictionForm.action = `{{ url_for('predict', disease_name='__key__') }}`.replace('__key__', diseaseKey);

            let html = '';
            const params = DISEASE_PARAMS[diseaseKey];

            if (params && params.length > 0) {
                // Add Gender field first for diabetes (UI only, not sent to model)
                if (diseaseKey === 'diabetes') {
                    html += `
                        <div class="form-group">
                            <label for="Gender">${getParameterLabel('Gender')}*</label>
                            <select id="Gender" name="_ui_gender" class="form-select" required onchange="togglePregnanciesField()">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                    `;
                }
                
                params.forEach(param => {
                    const labelText = getParameterLabel(param);
                    
                    // Hide Pregnancies by default if it's diabetes
                    const isPregnancies = param === 'Pregnancies';
                    const hidden = diseaseKey === 'diabetes' && isPregnancies ? 'style="display:none;"' : '';
                    const groupId = isPregnancies ? 'Pregnancies-group' : '';
                    
                    if (CATEGORICAL_FIELDS.includes(param)) {
                        html += `
                            <div class="form-group" id="${groupId}" ${hidden}>
                                <label for="${param}">${labelText}*</label>
                                <select id="${param}" name="${param}" class="form-select" required>
                                    ${getDropdownOptions(param, diseaseKey)}
                                </select>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="form-group" id="${groupId}" ${hidden}>
                                <label for="${param}">${labelText}*</label>
                                <input type="number" step="any" id="${param}" name="${param}" class="form-input" required>
                            </div>
                        `;
                    }
                });
            } else {
                html = '<p>Error: No parameters found for this disease.</p>';
            }

            inputArea.innerHTML = html;
            formContainer.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
            formContainer.scrollIntoView({ behavior: 'smooth' });
            
            // Re-attach the toggle function for the new Gender selector
            setTimeout(() => {
                const genderSelect = document.querySelector('[name="_ui_gender"]');
                if (genderSelect) {
                    genderSelect.addEventListener('change', togglePregnanciesField);
                }
            }, 0);
        };

        predictionForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            loadingSpinner.classList.remove('hidden');
            resultsContainer.classList.add('hidden');

            const formData = new FormData(predictionForm);

            try {
                const response = await fetch(predictionForm.action, {
                    method: 'POST',
                    body: new URLSearchParams(formData),
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                });

                const data = await response.json();
                loadingSpinner.classList.add('hidden');

                if (data.status === 'success') {
                    resultsContainer.innerHTML = data.html;
                    resultsContainer.classList.remove('hidden');
                    resultsContainer.scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Prediction Error: ' + data.error);
                }
            } catch (error) {
                loadingSpinner.classList.add('hidden');
                alert('An error occurred during network submission.');
                console.error('Fetch error:', error);
            }
        });
    };
</script>
{% endblock %}
